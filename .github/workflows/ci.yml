# This workflow will do the following when a pull request is made against the main branch:
# 1. Clone base repository (apexcharts/apexcharts.js), install npm packages, build samples, and then generate e2e snapshots
# 2. Clone head repository (the repository with the code in the pull request), install npm packages, build samples, get snapshots generated from the base repository, run tests, and then generate an apexcharts build
# Test coverage results, base repository snapshots, head repository snapshots and diffs, sample HTML, and the apexcharts build are all uploaded to the workflow artifacts
# The diffs, build, and coverage results get uploaded even if the test fails for manual inspection and to make debugging easier

# There is also a job that tests to make sure new changes produce reproducible results in e2e tests

name: Node.js CI

on:
  pull_request:
    branches: [ test1 ]

jobs:
  ci:

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 19.x, 20.x, 21.x, 22.4.0, 22.4.1, 22.5.0]
        os: [ubuntu-20.04, ubuntu-22.04, macos-12, macos-13, macos-14, windows-2019, windows-2022]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
    - name: Create base repository artifacts folder
      run: mkdir -p ${{ runner.temp }}/artifacts/base-repository
    - name: Create head repository artifacts folder
      run: mkdir -p ${{ runner.temp }}/artifacts/head-repository

    - name: Get npm version
      run: npm -v

    - name: Checkout
      uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install base repository's packages
      run: npm ci
    - name: Generate base repository's samples
      run: npm run build:samples
    - name: Generate snapshots
      run: npm run e2e:update
    - name: Run tests
      run: npm run test:ci

    - name: Upload Repo
      if: '!cancelled()'
      uses: actions/upload-artifact@v3
      with:
        name: node${{ matrix.node-version }}${{ matrix.os }}repoci
        path: ${{ github.workspace }}

  install:

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 19.x, 20.x, 21.x, 22.4.0, 22.4.1, 22.5.0]
        os: [ubuntu-20.04, ubuntu-22.04, macos-12, macos-13, macos-14, windows-2019, windows-2022]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
    - name: Create base repository artifacts folder
      run: mkdir -p ${{ runner.temp }}/artifacts/base-repository
    - name: Create head repository artifacts folder
      run: mkdir -p ${{ runner.temp }}/artifacts/head-repository

    - name: Get npm version
      run: npm -v

    - name: Checkout
      uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install base repository's packages
      run: npm install
    - name: Generate base repository's samples
      run: npm run build:samples
    - name: Generate snapshots
      run: npm run e2e:update
    - name: Run tests
      run: npm run test:ci

    - name: Upload Repo
      if: '!cancelled()'
      uses: actions/upload-artifact@v4
      with:
        name: node${{ matrix.node-version }}${{ matrix.os }}repoinstall
        path: ${{ github.workspace }}
